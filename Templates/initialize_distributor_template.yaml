GS2TemplateFormatVersion: "2019-05-01"
Description: GS2-Distributor initialize template Version 2022-07-25

Globals:
  Alias:
    DistributorNamespaceName: distributor-0001  # リソースの入手処理をGS2-Distributorを経由することで所持数量制限で溢れた場合のGS2-Inboxへの転送処理が自動的に行われる
                                                # By passing the resource acquisition process through GS2-Distributor, the transfer process to GS2-Inbox is automatically performed in case of overflow due to possession quantity limitation.
    DeliveryUserName: distribute-user           # リソースの入手処理を実行する権限を持つ GS2-Identifier ユーザー
                                                # GS2-Identifier user authorized to perform the resource acquisition process
    JobQueueNamespaceName: job-queue            # GS2-JobQueue ネームスペース名 / Namespace name
    GatewayNamespaceName: gateway-0001          # 通知を行う GS2-Gatewayネームスペース名 / GS2-Gateway namespace name for notification

Resources:
  IdentifierDeliveryUser:
    Type: GS2::Identifier::User
    Properties:
      Name: ${DeliveryUserName}

  IdentifierDeliveryUserAttachPolicy:
    Type: GS2::Identifier::AttachSecurityPolicy
    Properties:
      UserName: ${DeliveryUserName}
      SecurityPolicyId: grn:gs2::system:identifier:securityPolicy:DeliveryAccess
    DependsOn:
      - IdentifierDeliveryUser

  DistributorNamespace:
    Type: GS2::Distributor::Namespace
    Properties:
      Name: ${DistributorNamespaceName}
      AssumeUserId: !GetAttr IdentifierDeliveryUser.Item.UserId
    DependsOn:
      - IdentifierDeliveryUser

  JobQueueNamespace:
    Type: GS2::JobQueue::Namespace
    Properties:
      Name: ${JobQueueNamespaceName}
      PushNotification:
        GatewayNamespaceId: !Join
          - ':'
          - - 'grn'
            - 'gs2'
            - !GetAttr Gs2::Region
            - !GetAttr Gs2::OwnerId
            - 'gateway'
            - ${GatewayNamespaceName}

Outputs:
  DistributorNamespaceName: !GetAttr DistributorNamespace.Item.Name
  JobQueueNamespaceName: !GetAttr JobQueueNamespace.Item.Name
  JobQueueNamespaceId: !GetAttr JobQueueNamespace.Item.NamespaceId
